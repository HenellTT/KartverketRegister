@using System.Globalization
@model KartverketRegister.Models.Marker
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Review Marker";
    var token = Antiforgery.GetAndStoreTokens(Context).RequestToken;
}

@section Styles {
    <link rel="stylesheet" href="~/css/Admin.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/Admin-Review.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
}

<h2>Review Marker</h2>

<div class="ap">
    <div class="information-ap">
        <div id="marker-info" class="mb-4">
            <p><b>Marker ID:</b> @Model.MarkerId</p>
            <p><b>Name:</b> @(Model.UserName ?? "N/A")</p>
            <p><b>Description:</b> @Model.Description</p>
            <p><b>Type:</b> @Model.Type</p>
            <p><b>Latitude:</b> @Model.Lat.ToString(CultureInfo.InvariantCulture)</p>
            <p><b>Longitude:</b> @Model.Lng.ToString(CultureInfo.InvariantCulture)</p>
            <p><b>Height (m):</b> @Model.HeightM</p>
            <p><b>Height Over Sea (m):</b> @Model.HeightMOverSea</p>
            <p><b>Organization:</b> @Model.Organization</p>
            <p><b>Accuracy (m):</b> @Model.AccuracyM</p>
            <p><b>Obstacle Category:</b> @Model.ObstacleCategory</p>
            <p><b>Temporary:</b> @(Model.IsTemporary ? "Yes" : "No")</p>
            <p><b>Expected Removal Date:</b> @(Model.ExpectedRemovalDate?.ToString("yyyy-MM-dd") ?? "N/A")</p>
            <p><b>Lighting:</b> @Model.Lighting</p>
            <p><b>Source:</b> @Model.Source</p>
            <p><b>Submitted by User ID:</b> @Model.UserId</p>
        </div>

        <div class="review-actions">
            <div class="action-buttons">
                <button type="button" onclick="setStatus('Approve', this)" class="ar-button ar-approve">
                    ✓ Approve
                </button>
                <button type="button" onclick="setStatus('Reject', this)" class="ar-button ar-reject">
                    ✗ Reject
                </button>
            </div>

            <form id="review-form">
                @Html.AntiForgeryToken()
                
                <label for="review-comment"><b>Review comment:</b></label>
                <textarea name="ReviewComment" 
                          required 
                          id="review-comment" 
                          rows="4" 
                          placeholder="Write your review here..."></textarea>

                <input type="hidden" id="statusi" name="Status">
                <input type="hidden" name="MarkerId" value="@Model.MarkerId">

                <button type="submit" class="submit-btn" id="submit-btn" disabled>
                    Submit Review
                </button>
            </form>

            <div id="status" class="status-message"></div>
        </div>
    </div>
    <div id="map"></div>
</div>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="~/js/MapFunctions.js"></script>
    <script src="~/js/icons.js"></script>

    <script>
        // Aktiverer submit-knappen kun når en status er valgt
        function setStatus(value, buttonElement) {
            const statusInput = document.getElementById('statusi');
            const submitBtn = document.getElementById('submit-btn');
            
            statusInput.value = value;
            submitBtn.disabled = false;

            // Fjern highlight fra alle knapper
            document.querySelectorAll(".ar-button").forEach(el => {
                el.classList.remove("ar-button-clicked");
            });

            // Legg til highlight på klikket knapp
            buttonElement.classList.add('ar-button-clicked');
        }

        // Håndter skjema-innsending via AJAX
        document.getElementById('review-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const statusDiv = document.getElementById('status');
            const submitBtn = document.getElementById('submit-btn');
            
            // Deaktiver knapp under innsending
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const response = await fetch('@Url.Action("HandleReview", "Admin")', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                if (data.success) {
                    statusDiv.className = 'status-message success';
                    statusDiv.textContent = data.message || 'Marker saved successfully! Redirecting...';
                    form.reset();
                    
                    // Fjern knapp-highlight
                    document.querySelectorAll(".ar-button-clicked").forEach(el => {
                        el.classList.remove("ar-button-clicked");
                    });
                    
                    // Redirect til admin-oversikt
                    setTimeout(() => {
                        window.location.href = '@Url.Action("Index", "Admin")';
                    }, 1000);
                } else {
                    statusDiv.className = 'status-message error';
                    statusDiv.textContent = data.message || 'Error saving marker.';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Review';
                }
            } catch (error) {
                console.error('Error:', error);
                statusDiv.className = 'status-message error';
                statusDiv.textContent = 'Error saving marker. Please try again.';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Review';
            }
        });

        // Kart-initialisering med markørens koordinater (ikke London!)
        const markerLat = @Model.Lat.ToString(CultureInfo.InvariantCulture);
        const markerLng = @Model.Lng.ToString(CultureInfo.InvariantCulture);
        
        var map = L.map('map').setView([markerLat, markerLng], 15);
        
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Last ikoner og vis markør
        fetch("/icon/geticons")
            .then(res => res.json())
            .then((IconList) => {
                const icons = new Icons(IconList);
                const mf = new MapFunctions(map, L, icons);
                
                const type = "@Model.ObstacleCategory".toLowerCase().replace(/\s+/g, "");
                const icon = mf.icons.Get[type];
                
                mf.setMarkerPosition(markerLat, markerLng, icon);
                mf.setViewTo(markerLat, markerLng, 17);
            })
            .catch(err => console.error("Failed to load icons:", err));

        // Håndter GeoJSON hvis tilgjengelig
        const geoJsonRaw = '@Html.Raw(Model.GeoJson ?? "null")';
        
        if (geoJsonRaw && geoJsonRaw !== "null") {
            try {
                // Dekod HTML-entiteter
                const parser = new DOMParser();
                const decoded = parser.parseFromString(geoJsonRaw, "text/html").documentElement.textContent;
                const geoJson = JSON.parse(decoded);
                
                if (geoJson) {
                    const geoLayer = L.geoJSON(geoJson).addTo(map);
                    const bounds = geoLayer.getBounds();
                    
                    if (bounds.isValid()) {
                        setTimeout(() => {
                            map.fitBounds(bounds, { padding: [40, 40] });
                        }, 500);
                    }
                }
            } catch (err) {
                console.error("Failed to parse GeoJSON:", err);
            }
        }
    </script>
}
